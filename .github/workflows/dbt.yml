name: dbt
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      env:
        description: Environment
        required: true
        default: dev
        type: choice
        options: [dev, stg, prod]

jobs:
  build:
    runs-on: ubuntu-latest
    # Bind to 'dev' on push, or to the chosen env on manual runs
    environment: ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'dev' }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Guarantee an account value is set for dbt
      - name: Ensure SNOWFLAKE_ACCOUNT_IDENTIFIER
        run: |
          if [ -z "${SNOWFLAKE_ACCOUNT_IDENTIFIER}" ]; then
            echo "SNOWFLAKE_ACCOUNT_IDENTIFIER=${SNOWFLAKE_ORGANIZATION_NAME}-${SNOWFLAKE_ACCOUNT_NAME}" >> "$GITHUB_ENV"
          fi
        env:
          SNOWFLAKE_ORGANIZATION_NAME: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}
          SNOWFLAKE_ACCOUNT_NAME:      ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_ACCOUNT_IDENTIFIER: ${{ secrets.SNOWFLAKE_ACCOUNT_IDENTIFIER }}

      - name: Load fake data into RAW
        env:
          ENV:                         ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'dev' }}
          # Account variants; profiles.yml will pick one
          SNOWFLAKE_ACCOUNT:           ${{ secrets.SNOWFLAKE_ACCOUNT }}            # optional
          SNOWFLAKE_ACCOUNT_IDENTIFIER: ${{ env.SNOWFLAKE_ACCOUNT_IDENTIFIER }}
          SNOWFLAKE_ORGANIZATION_NAME: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}
          SNOWFLAKE_ACCOUNT_NAME:      ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_USER:              ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:          ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:              ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE:         ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: python scripts/generate_fake_data.py

      - name: dbt build
        env:
          # Same env set for dbt
          SNOWFLAKE_ACCOUNT:           ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_ACCOUNT_IDENTIFIER: ${{ env.SNOWFLAKE_ACCOUNT_IDENTIFIER }}
          SNOWFLAKE_ORGANIZATION_NAME: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}
          SNOWFLAKE_ACCOUNT_NAME:      ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_USER:              ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:          ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:              ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE:         ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: |
          dbt --version
          dbt build --profiles-dir . --target ${{ github.event_name == 'workflow_dispatch' && inputs.env || 'dev' }}
