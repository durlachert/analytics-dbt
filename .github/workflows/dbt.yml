name: dbt
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      env:
        description: Environment
        required: true
        default: dev
        type: choice
        options: [dev, stg, prod]

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Load fake data into RAW
        env:
          ENV:                         ${{ inputs.env || 'dev' }}
          SNOWFLAKE_ORGANIZATION_NAME: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}
          SNOWFLAKE_ACCOUNT_NAME:      ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_ACCOUNT_IDENTIFIER: ${{ secrets.SNOWFLAKE_ACCOUNT_IDENTIFIER }}
          SNOWFLAKE_USER:              ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:          ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:              ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE:         ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: python scripts/generate_fake_data.py

      - name: dbt build
        env:
          # dbt uses profiles.yml + env vars below
          SNOWFLAKE_ORGANIZATION_NAME: ${{ secrets.SNOWFLAKE_ORGANIZATION_NAME }}
          SNOWFLAKE_ACCOUNT_NAME:      ${{ secrets.SNOWFLAKE_ACCOUNT_NAME }}
          SNOWFLAKE_ACCOUNT_IDENTIFIER: ${{ secrets.SNOWFLAKE_ACCOUNT_IDENTIFIER }}
          SNOWFLAKE_USER:              ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:          ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:              ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE:         ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: |
          dbt --version
          # target == env input (dev/stg/prod)
          dbt build --profiles-dir . --target ${{ inputs.env || 'dev' }}
